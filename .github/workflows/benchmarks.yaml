name: Run Benchmarks
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ 25 ] 

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
        
      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v5

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build
        run: ./gradlew build

  jmh:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ 25 ]
        module:
          - baseline
          - cfg4j
          - externalized-properties
          - gestalt-config
          - lightbend-config
          - microprofile-geronimo
          - microprofile-helidon
          - microprofile-kumuluz-ee
          - microprofile-microbean
          - microprofile-smallrye
          - owner
          - spring-core
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v5

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
      
      - name: Run ${{ matrix.module }} Benchmarks
        run: ./gradlew :${{ matrix.module }}:jmh

      - name: Upload ${{ matrix.module }} Results
        uses: actions/upload-artifact@v4
        with:
          name: jmh-results-${{ matrix.module }}
          path: ${{ matrix.module }}/build/reports/jmh/results.json

  merge:
    needs: jmh
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ 25 ]
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
        
      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v5

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
      
      - name: Download JMH Results
        uses: actions/download-artifact@v7
        with:
          path: jmh-results
          pattern: jmh-results-*
      
      - name: Organize Results
        run: |
          for module_dir in jmh-results/jmh-results-*/; do
            module_name=$(basename "$module_dir" | sed 's/jmh-results-//')
            mkdir -p "$module_name/build/reports/jmh"
            cp "$module_dir/results.json" "$module_name/build/reports/jmh/results.json"
          done
      
      - name: Merge JMH Results
        run: ./gradlew mergeJmhResults jmhReport

      - name: Deploy Merged Benchmark Results to Gist
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.TOKEN }}
          gist_id: 016a70a392934d0e5a07a4d291731218
          file_path: merged-jmh-results/merged-jmh-results.json
          file_type: json

      - name: GH Pages Upload
        uses: s0/git-publish-subdir-action@v2.6.0
        env:
          REPO: self
          BRANCH: gh-pages
          FOLDER: merged-jmh-results
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
